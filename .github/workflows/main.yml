# Este workflow é acionado em push para o branch 'main'.
# Ele faz o build do projeto Python e o deploy no Azure Function App.

name: Deploy B3 Analysis Function App

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: 'b3-mms-func-app'    # NOME EXATO do seu Function App
  PYTHON_VERSION: '3.10'
  REQUIREMENTS_FILE: 'requirements.txt'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python environment
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: 'Resolve project dependencies'
        run: |
          pip install --upgrade pip
          if [ -f ${{ env.REQUIREMENTS_FILE }} ]; then pip install -r ${{ env.REQUIREMENTS_FILE }}; fi

      # ----------------------------------------------------
      # DEPLOY STEP: USA O PUBLISH_PROFILE (método mais simples)
      # ----------------------------------------------------
      - name: 'Deploy to Azure Functions'
        uses: Azure/functions-action@v1
        with:
          # PUBLISH_PROFILE deve ser o Segredo XML que configuramos no Passo 2.
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }} 
          package: '.' # Implanta a pasta raiz
          functionapp-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          
      - name: Deployment completed successfully
        run: echo "Deployment of ${{ env.AZURE_FUNCTIONAPP_NAME }} successful."